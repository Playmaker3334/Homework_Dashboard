<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Earthquake Intelligence Dashboard</title>

<!-- ========== THEME & RESET ================================= -->
<style>
:root{
  /* --- Palette --- */
  --bg:#0b0d10;          /* page background                        */
  --panel:#181c23;       /* card background                        */
  --text:#e4e4e9;        /* main text                              */
  --muted:#8d8d96;       /* muted / secondary text                 */
  --accent:#a66bff;      /* accent purple                          */
  --accent-light:#be8cff;/* lighter variant for fills              */
  --grid:rgba(255,255,255,.06);
  --font:"Inter",system-ui,sans-serif;
  --radius:18px;
}
@media(prefers-color-scheme:light){
  :root{
    --bg:#f3f4f7;--panel:#ffffff;--text:#1f1f23;--muted:#62626a;
    --grid:rgba(0,0,0,.1);--accent:#7046ff;--accent-light:#8c68ff;
  }
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:var(--bg);color:var(--text);font-family:var(--font);
  display:flex;flex-direction:column;min-height:100vh
}
a{color:var(--accent);text-decoration:none}
button{
  cursor:pointer;border:none;border-radius:var(--radius);
  background:var(--accent);color:#fff;font:inherit;
  padding:.45rem .95rem;font-size:.9rem
}
button:hover{opacity:.9}
select{
  background:var(--panel);color:var(--text);
  border:1px solid var(--grid);border-radius:10px;
  padding:.35rem .65rem;font-size:.9rem
}

/* ========== NAV ============================================ */
#nav{
  display:flex;align-items:center;justify-content:space-between;
  padding:1.1rem 1.6rem;background:var(--panel);
  box-shadow:0 0 30px rgba(0,0,0,.35)
}
#nav h1{
  font-size:1.15rem;font-weight:600;display:flex;gap:.55rem;align-items:center
}
#nav h1 span{font-size:.8rem;color:var(--muted)}

/* ========== GRID LAYOUT ==================================== */
#grid{
  flex:1;display:grid;grid-template-columns:2fr 35%;
  gap:2%;padding:1.6rem;max-width:1600px;margin:0 auto;width:100%
}
.section{
  background:var(--panel);border-radius:var(--radius);
  padding:1.6rem 1.8rem;box-shadow:0 0 35px rgba(0,0,0,.45);
  display:flex;flex-direction:column;min-height:0
}
h2{font-size:1.05rem;font-weight:600;margin-bottom:.85rem}

/* KPI list */
ul#kpi{list-style:none;font-size:.9rem;line-height:1.55}
ul#kpi strong{color:var(--accent)}

/* Live feed list */
#feed{margin-top:1rem;font-size:.8rem;line-height:1.45;overflow-y:auto}
#feed div{
  margin-bottom:.45rem;border-left:3px solid var(--accent);
  padding-left:.55rem;white-space:nowrap;text-overflow:ellipsis;overflow:hidden
}

/* ========== MODAL ========================================== */
#modal{
  position:fixed;inset:0;background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center;z-index:999
}
#modal .card{
  background:var(--panel);border-radius:var(--radius);
  width:92%;max-width:1100px;max-height:92vh;
  padding:2rem;display:flex;flex-direction:column
}
#tabs{display:flex;gap:.7rem;margin-bottom:1rem}
#tabs button{
  background:var(--grid);border-radius:10px;
  font-size:.85rem;padding:.4rem .85rem
}
#tabs .active{background:var(--accent)}
#close{
  align-self:flex-end;margin-bottom:1.2rem;
  background:var(--grid);color:var(--text)
}
canvas{width:100%!important;height:100%!important}

/* Responsive adjustments */
@media(max-width:900px){
  #grid{grid-template-columns:100%}
  #nav{flex-wrap:wrap;gap:.7rem}
}
</style>
</head>
<body>
<!-- ========== NAV ========================================== -->
<nav id="nav">
  <h1>üåç Earthquake Dashboard<span>(1-s playback)</span></h1>
  <div style="display:flex;align-items:center;gap:.7rem">
    <label for="range" style="font-size:.8rem;color:var(--muted)">Rango:</label>
    <select id="range">
      <option value="24">24 h</option>
      <option value="72">72 h</option>
      <option value="168">7 d√≠as</option>
    </select>
    <button id="btn-hist">Hist√≥rico üìä</button>
  </div>
</nav>

<!-- ========== GRID ========================================= -->
<main id="grid">
  <!-- ==== LINE CHART ====================================== -->
  <section id="line-sec" class="section">
    <h2>Magnitud vs Tiempo (UTC)</h2>
    <canvas id="line"></canvas>
    <small id="stamp" style="margin-top:.65rem;align-self:flex-end;color:var(--muted)">‚Äî</small>
  </section>

  <!-- ==== SIDE COLUMN ===================================== -->
  <section class="section" style="gap:1.3rem">
    <div style="flex:1;min-height:240px">
      <h2>Distribuci√≥n de magnitud</h2>
      <canvas id="hist"></canvas>
    </div>
    <div>
      <h2>Estad√≠sticas</h2>
      <ul id="kpi">
        <li>Total eventos: <strong id="k-total">0</strong></li>
        <li>Promedio magnitud: <strong id="k-avg">0.0</strong></li>
        <li>M√°x magnitud: <strong id="k-max">‚Äî</strong></li>
      </ul>
      <div id="feed" style="height:130px"></div>
    </div>
  </section>
</main>

<!-- ========== MODAL (HIST√ìRICO) ============================ -->
<div id="modal">
  <div class="card">
    <button id="close">‚úï Cerrar</button>
    <div id="tabs">
      <button data-tab="mean" class="active">Mag media / hora</button>
      <button data-tab="count">Conteo / hora</button>
    </div>
    <canvas id="modal-chart"></canvas>
  </div>
</div>

<!-- ========== LIBS ========================================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

<script>
/* ------------ CONFIG & HELPERS ---------------------------- */
const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
let hoursBack = 24;                   // rango seleccionado
const queue = [], seen = new Map();   // Map id -> event (para modal)
const histBins = Array(8).fill(0);    // 0-1 ‚Ä¶ 7+

/* ------------ CHART DATA ---------------------------------- */
const lineData = { labels: [], datasets:[{
  label:'Magnitude', data:[],
  borderColor:css('--accent'),backgroundColor:'rgba(0,0,0,0)',
  pointRadius:3,pointBackgroundColor:css('--accent'),
  borderWidth:2,tension:.25
}]};
const histData={labels:['0-1','1-2','2-3','3-4','4-5','5-6','6-7','7+'],
  datasets:[{data:histBins,backgroundColor:css('--accent-light'),borderWidth:0}]};

/* ------------ LINE CHART ---------------------------------- */
const lineChart = new Chart(document.getElementById('line'),{
  type:'line',data:lineData,
  options:{
    scales:{
      x:{type:'timeseries',time:{displayFormats:{second:'HH:mm:ss'}},
         grid:{color:css('--grid')},ticks:{autoSkip:true,maxRotation:0,minRotation:0}},
      y:{beginAtZero:true,grid:{color:css('--grid')},title:{display:true,text:'Mag'}}
    },
    plugins:{
      decimation:{enabled:true,algorithm:'lttb',samples:600}, // <-- evita ‚Äúamontonado‚Äù
      legend:{display:false},
      tooltip:{
        backgroundColor:'rgba(30,30,40,.92)',
        borderColor:css('--accent'),borderWidth:1,
        callbacks:{title:c=>new Date(c[0].parsed.x).toUTCString()}
      }
    },
    animation:{duration:0},responsive:true,maintainAspectRatio:false
  }
});

/* ------------ HIST CHART ---------------------------------- */
const histChart=new Chart(document.getElementById('hist'),{
  type:'bar',data:histData,
  options:{
    scales:{
      x:{grid:{display:false},ticks:{color:css('--muted')}},
      y:{beginAtZero:true,grid:{color:css('--grid')},ticks:{color:css('--muted')}}
    },
    plugins:{legend:{display:false}},animation:{duration:0},
    responsive:true,maintainAspectRatio:false
  }
});

/* ------------ KPI ----------------------------------------- */
let total=0,sum=0,maxMag=0;
const $kTotal=document.getElementById('k-total'),
      $kAvg  =document.getElementById('k-avg'),
      $kMax  =document.getElementById('k-max'),
      $feed  =document.getElementById('feed');

function updateKPIs(ev){
  total++; sum+=ev.mag; if(ev.mag>maxMag)maxMag=ev.mag;
  $kTotal.textContent=total;
  $kAvg.textContent=(sum/total).toFixed(2);
  $kMax.textContent=maxMag.toFixed(1);
  // live feed
  const row=document.createElement('div');
  row.textContent=`${ev.time.toUTCString().slice(17,25)} ‚Äî M${ev.mag.toFixed(1)} ¬∑ ${ev.place}`;
  $feed.prepend(row); if($feed.children.length>9)$feed.lastChild.remove();
}

/* ------------ DATA ---------------------------------------- */
function buildURL(){
  const start = new Date(Date.now()-hoursBack*3600*1e3).toISOString();
  return 'https://earthquake.usgs.gov/fdsnws/event/1/query'
       + '?format=geojson&starttime='+start
       + '&minmagnitude=0&orderby=time&limit=20000';
}
async function fetchFeed(){
  try{
    const geo = await (await fetch(buildURL())).json();
    geo.features.sort((a,b)=>a.properties.time-b.properties.time).forEach(f=>{
      if(seen.has(f.id))return;
      const ev={
        id:f.id,mag:f.properties.mag,place:f.properties.place||'‚Äî',
        time:new Date(f.properties.time),
        depth:f.geometry.coordinates[2],
        lon:f.geometry.coordinates[0],lat:f.geometry.coordinates[1]
      };
      seen.set(f.id,ev); queue.push(ev);
    });
    document.getElementById('stamp').textContent=
      'Sync '+new Date().toLocaleTimeString('es-MX',{hour12:false});
  }catch(err){console.error(err);}
}
fetchFeed(); setInterval(fetchFeed,60_000);

/* Playback (1 evento / s) */
setInterval(()=>{
  if(!queue.length)return;
  const ev=queue.shift();
  lineData.labels.push(ev.time);
  lineData.datasets[0].data.push(ev.mag);
  if(lineData.labels.length>360){
    lineData.labels.shift();lineData.datasets[0].data.shift();
  }
  lineChart.update('none');
  // histogram
  const idx=Math.min(7,ev.mag<1?0:Math.floor(ev.mag));
  histBins[idx]++; histChart.update('none');
  updateKPIs(ev);
},1_000);

/* ------------ RANGE SELECTOR ------------------------------ */
document.getElementById('range').onchange=e=>{
  hoursBack=+e.target.value;
  // reset everything
  queue.length=0; seen.clear();
  lineData.labels.length=0; lineData.datasets[0].data.length=0; lineChart.update();
  histBins.fill(0); histChart.update();
  total=sum=maxMag=0;
  [$kTotal,$kAvg,$kMax].forEach(el=>el.textContent='0');
  $feed.innerHTML='';
  fetchFeed();
};

/* ------------ MODAL HIST√ìRICO ----------------------------- */
let modalChart;
const modal=document.getElementById('modal'), ctxModal=document.getElementById('modal-chart').getContext('2d');
function openModal(tab='mean'){ modal.style.display='flex'; loadModal(tab); }
function closeModal(){ modal.style.display='none'; }
function loadModal(tab){
  const buckets={}, now=Date.now(), start=now-hoursBack*3600*1e3;
  // crear buckets por hora
  seen.forEach(ev=>{
    if(ev.time.getTime()<start)return;
    const key=Math.floor(ev.time.getTime()/3.6e6)*3.6e6;
    (buckets[key]=buckets[key]||{sum:0,cnt:0}).cnt++;
    buckets[key].sum+=ev.mag;
  });
  const labels=Object.keys(buckets).sort().map(t=>new Date(+t));
  const mean=labels.map(l=>(buckets[l.getTime()].sum/buckets[l.getTime()].cnt).toFixed(2));
  const cnt =labels.map(l=>buckets[l.getTime()].cnt);

  if(modalChart)modalChart.destroy();
  modalChart=new Chart(ctxModal,{
    type:'bar',
    data:{labels,
      datasets:[tab==='mean'
        ?{label:'Mag media',data:mean,backgroundColor:css('--accent')}
        :{label:'Conteo',data:cnt,backgroundColor:css('--accent-light')}]},
    options:{
      scales:{
        x:{type:'timeseries',time:{unit:'hour'},grid:{color:css('--grid')},
           ticks:{maxRotation:0,minRotation:0,color:css('--muted')}},
        y:{beginAtZero:true,grid:{color:css('--grid')},ticks:{color:css('--muted')}}
      },
      plugins:{legend:{display:false},decimation:{enabled:true,algorithm:'lttb',samples:200}},
      responsive:true,maintainAspectRatio:false
    }
  });
  [...document.querySelectorAll('#tabs button')].forEach(b=>b.classList.remove('active'));
  document.querySelector(`#tabs button[data-tab="${tab}"]`).classList.add('active');
}
document.getElementById('btn-hist').onclick=()=>openModal();
document.getElementById('close').onclick=closeModal;
document.querySelectorAll('#tabs button').forEach(b=>b.onclick=()=>loadModal(b.dataset.tab));
modal.addEventListener('click',e=>{ if(e.target===modal)closeModal(); });
</script>
</body>
</html>
